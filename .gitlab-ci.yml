stages:
  - build
  - static_analysis
  - dep_scan
  - test
  - coverage
  - policy
  - shared_test
  - docs

variables:
  BUILD_DIR: build
  COVERAGE_THRESHOLD: "70"

# ---------------- BUILD ----------------
build_c:
  stage: build
  image: gcc:13
  script:
    - mkdir -p $BUILD_DIR
    - gcc -Wall -Wextra -O2 -o $BUILD_DIR/vuln_demo src/vuln_demo.c src/vuln_demo_main.c
  artifacts:
    paths:
      - $BUILD_DIR/vuln_demo
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'

# ---------------- STATIC ANALYSIS ----------------
cppcheck:
  stage: static_analysis
  image: debian:stable
  before_script:
    - apt-get update && apt-get install -y cppcheck
  script:
    - cppcheck --enable=warning,style,performance,portability --force src | tee ci/cppcheck.log
  artifacts:
    paths:
      - ci/cppcheck.log
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'

# ---------------- DEPENDENCY SCAN ----------------
dependency_check:
  stage: dep_scan
  image: owasp/dependency-check:latest
  script:
    - mkdir -p reports
    - dependency-check.sh --scan . --format "HTML" --out reports --project "trucks-src-lab"
  artifacts:
    paths:
      - reports/dependency-check-report.html
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'

# ---------------- UNIT TESTS ----------------
unit_test_unity:
  stage: test
  image: gcc:13
  before_script:
    - apt-get update && apt-get install -y python3
  script:
    - mkdir -p $BUILD_DIR/test/test_vuln_demo reports
    - gcc -Wall -Wextra -fprofile-arcs -ftest-coverage \
        -Iunity \
        -o $BUILD_DIR/test/test_vuln_demo/test_vuln_demo \
        tests/test_vuln_demo.c src/vuln_demo.c unity/unity.c
    - $BUILD_DIR/test/test_vuln_demo/test_vuln_demo > reports/unity_output.txt
    - python3 scripts/unity_to_junit.py reports/unity_output.txt reports/junit.xml
  artifacts:
    when: always
    reports:
      junit: reports/junit.xml
    paths:
      - $BUILD_DIR/test/test_vuln_demo/test_vuln_demo
      - $BUILD_DIR/test/test_vuln_demo/*.gcno
      - $BUILD_DIR/test/test_vuln_demo/*.gcda
      - reports/unity_output.txt
      - reports/junit.xml
    expire_in: 4 weeks

# ---------------- COVERAGE ----------------
coverage_check:
  stage: coverage
  image: debian:stable
  before_script:
    - apt-get update && apt-get install -y bc gcov
  script:
    - mkdir -p coverage
    - gcov -o $BUILD_DIR/test/test_vuln_demo src/*.c > coverage/coverage.txt
    - COVERAGE=$(grep -Po 'Lines executed:\s*\K[0-9.]+' coverage/coverage.txt | head -1)
    - >
      if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
        echo "Coverage below threshold (${COVERAGE_THRESHOLD}%)"
        exit 1
      else
        echo "Coverage meets threshold (${COVERAGE_THRESHOLD}%)"
      fi
  artifacts:
    paths:
      - coverage/coverage.txt
      - $BUILD_DIR/test/test_vuln_demo/*.gcno
      - $BUILD_DIR/test/test_vuln_demo/*.gcda
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'
# ---------------- Runner check ----------------
sanity_check:
  stage: build
  script:
    - echo "Runner is working"

# ---------------- POLICY GATE ----------------
policy_gate:
  stage: policy
  image: debian:stable
  script:
    - set -e
    - if grep -E "error:|warning:|style:" ci/cppcheck.log; then echo "Cppcheck issues found"; exit 1; fi
    - if grep -E "High|Critical" reports/dependency-check-report.html; then echo "High/Critical CVEs found"; exit 1; fi
    - if grep -q 'failures="0"' reports/junit.xml; then echo "Unit tests passed"; else echo "Unit test failures detected"; exit 1; fi
    - if [ ! -f "$BUILD_DIR/vuln_demo" ]; then echo "Build artifact missing"; exit 1; fi
    - echo "Policy gate passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'

# ---------------- SHARED TEST ----------------
shared_test:
  stage: shared_test
  script:
    - echo "Running on shared runner"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'

# ---------------- PROJECT STRUCTURE ----------------
project_structure:
  stage: docs
  image: alpine:latest
  before_script:
    - apk add --no-cache tree
  script:
    - mkdir -p reports
    - tree -a -L 2 > reports/project_structure.txt
  artifacts:
    paths:
      - reports/project_structure.txt
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "feature/Unity"'
