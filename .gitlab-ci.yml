stages:
  - build
  - static_analysis
  - dep_scan
  - test
  - coverage
  - policy

variables:
  BUILD_DIR: build
  COVERAGE_THRESHOLD: "70"  # Minimum coverage percentage required

build_c:
  stage: build
  image: gcc:13
  script:
    - mkdir -p $BUILD_DIR
    - gcc -Wall -Wextra -O2 -o $BUILD_DIR/vuln_demo src/vuln_demo.c
  artifacts:
    paths:
      - $BUILD_DIR/vuln_demo
    expire_in: 1 week

cppcheck:
  stage: static_analysis
  image: debian:stable
  before_script:
    - apt-get update && apt-get install -y cppcheck
  script:
    - cppcheck --enable=warning,style,performance,portability --force src | tee cppcheck.log
  artifacts:
    paths:
      - cppcheck.log
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always

dependency_check:
  stage: dep_scan
  image: owasp/dependency-check:latest
  script:
    - mkdir -p reports
    - dependency-check.sh --scan . --format "HTML" --out reports
  artifacts:
    paths:
      - reports
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always

unit_test_unity:
  stage: test
  image: gcc:13
  before_script:
    - apt-get update && apt-get install -y python3
  script:
    - mkdir -p $BUILD_DIR reports coverage
    # Compile Unity tests with coverage flags
    - gcc -Wall -Wextra -fprofile-arcs -ftest-coverage -o $BUILD_DIR/test tests/test_vuln_demo.c src/demo.c unity/unity.c
    # Run Unity tests and capture output
    - ./build/test > reports/unity_output.txt || true
    # Convert Unity output to JUnit XML
    - python3 scripts/unity_to_junit.py reports/unity_output.txt reports/junit.xml
    # Move coverage files into a dedicated folder
    - mv *.gcda *.gcno coverage/ || true
  artifacts:
    when: always
    reports:
      junit: reports/junit.xml
    paths:
      - $BUILD_DIR/test
      - reports/unity_output.txt
      - reports/junit.xml
      - coverage/
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always


#coverage_check:
#  stage: coverage
#  image: gcc:13
#  script:
#    - mkdir -p coverage
#    - gcov -o $BUILD_DIR src/*.c > coverage/coverage.txt
#    - COVERAGE=$(grep -Po 'Lines executed:\s*\K[0-9.]+' coverage/coverage.txt | head -1)
    #- echo "Coverage detected: ${COVERAGE}%"
#    - if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
#        echo "Coverage below threshold ($COVERAGE_THRESHOLD%)";
#        exit 1;
#      else
#        echo "Coverage meets threshold ($COVERAGE_THRESHOLD%)";
#      fi
#  artifacts:
#    paths:
#      - coverage/coverage.txt
#    expire_in: 1 week
#  rules:
#    - if: '$CI_COMMIT_BRANCH == "main"'
#      when: always

coverage_check:
  stage: coverage
  image: gcc:13
  variables:
    COVERAGE_THRESHOLD: "70"
  script:
    - mkdir -p coverage
    - gcov -o $BUILD_DIR src/*.c > coverage/coverage.txt
    - COVERAGE=$(grep -Po 'Lines executed:\s*\K[0-9.]+' coverage/coverage.txt | head -1)
    - >
      if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
        echo "Coverage below threshold (${COVERAGE_THRESHOLD}%)"
        exit 1
      else
        echo "Coverage meets threshold (${COVERAGE_THRESHOLD}%)"
      fi
  artifacts:
    paths:
      - coverage/coverage.txt
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always

policy_gate:
  stage: policy
  image: debian:stable
  script:
    - set -e
    - if grep -E "error:|warning:|style:" cppcheck.log; then echo "Cppcheck issues found"; exit 1; fi
    - if grep -E "High|Critical" reports/dependency-check-report.html; then echo "High/Critical CVEs found"; exit 1; fi
    - if grep -q 'failures="0"' reports/junit.xml; then echo "Unit tests passed"; else echo "Unit test failures detected"; exit 1; fi
    - if [ ! -f "$BUILD_DIR/vuln_demo" ]; then echo "Build artifact missing"; exit 1; fi
    - echo "Policy gate passed"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: always